- hosts: all

  vars_prompt:
    - name: sshd_port
      prompt: "Port to use for sshd"
      default: "{{ 9000 | random(start=2000) }}"

  tasks:
    - name: Create .ssh directory
      file:
        path: "{{ ansible_env.HOME }}/.ssh"
        state: directory
        owner: "{{ main_user }}"
        group: "{{ main_user }}"

    - name: Copy authorised keys
      copy:
        src: ../files/ssh_authorized_keys
        dest: "{{ ansible_env.HOME }}/.ssh/authorized_keys"
        owner: "{{ main_user }}"
        group: "{{ main_user }}"
        mode: 0600

    - name: Copy sshd config
      become: true
      template:
        src: ../templates/system/etc/ssh/sshd_config.j2
        dest: /etc/ssh/sshd_config

    - name: Restart SSH service (sshd)
      become: true
      systemd:
        name: sshd
        state: restarted
